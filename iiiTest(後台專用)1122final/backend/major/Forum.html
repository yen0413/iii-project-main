<!--
=========================================================
 Light Bootstrap Dashboard - v2.0.1
=========================================================

 Product Page: https://www.creative-tim.com/product/light-bootstrap-dashboard
 Copyright 2019 Creative Tim (https://www.creative-tim.com)
 Licensed under MIT (https://github.com/creativetimofficial/light-bootstrap-dashboard/blob/master/LICENSE)

 Coded by Creative Tim

=========================================================

 The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.  -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
    <link rel="icon" type="image/png" href="../assets/img/favicon.svg">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Gladxy Co.有限公司後台</title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no'
        name='viewport' />
    <!--     Fonts and icons     -->

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" />
    <!-- CSS Files -->
    <link href="../assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../assets/css/light-bootstrap-dashboard.css?v=2.0.0 " rel="stylesheet" />
    <!-- CSS Just for demo purpose, don't include it in your project -->
    <link href="../assets/css/demo.css" rel="stylesheet" />
    <script defer src="https://use.fontawesome.com/releases/v5.0.10/js/all.js"
        integrity="sha384-slN8GvtUJGnv6ca26v8EzVaR9DC58QEwsIk9q1QXdCU8Yu8ck/tL/5szYlBbqmS+"
        crossorigin="anonymous"></script>
    <script src="https://cdn.ckeditor.com/4.15.0/standard/ckeditor.js"></script>
    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"
        integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous"> -->

    <style>
        .fa-edit,
        .fa-trash-alt {
            margin-left: 10px;
        }

        .search_txt {
            margin-right: 5px;

        }

        .marginleft {
            margin-left: 5px;
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <div class="sidebar" data-image="../assets/img/sidebar-5.jpg">
            <!--
        Tip 1: You can change the color of the sidebar using: data-color="purple | blue | green | orange | red"

        Tip 2: you can also add an image using data-image tag
    -->
            <div class="sidebar-wrapper">
                <div class="logo">
                    <a href="" class="simple-text">
                        員工福利網
                    </a>
                </div>
                <ul class="nav">
                    <li>
                        <a class="nav-link" href="index.html">
                            <i class="nc-icon nc-chart-pie-35"></i>
                            <p>主頁</p>
                        </a>
                    </li>
                    <li>
                        <a class="nav-link" href="./Blogtable.html">
                            <i class="nc-icon nc-notes"></i>
                            <p>部落格</p>
                        </a>
                    </li>
                    <li>
                        <a class="nav-link" href="./Emptable.html">
                            <i class="nc-icon nc-notes"></i>
                            <p>員工</p>
                        </a>
                    </li>
                    <!-- <li>
                        <a class="nav-link" href="./Event.html">
                            <i class="nc-icon nc-notes"></i>
                            <p>開團</p>
                        </a>
                    </li> -->
                    <li>
                        <a class="nav-link" href="./Forum.html">
                            <i class="nc-icon nc-notes"></i>
                            <p>討論區</p>
                        </a>
                    </li>
                    <li>
                        <a class="nav-link" href="./Protable.html">
                            <i class="nc-icon nc-notes"></i>
                            <p>團購</p>
                        </a>
                    </li>

                </ul>
            </div>
        </div>
        <div class="main-panel">
            <!-- Navbar -->
            <nav class="navbar navbar-expand-lg " color-on-scroll="500">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#pablo"> 討論區後台管理 </a>
                    <button href="" class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
                        aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-bar burger-lines"></span>
                        <span class="navbar-toggler-bar burger-lines"></span>
                        <span class="navbar-toggler-bar burger-lines"></span>
                    </button>
                    <div class="collapse navbar-collapse justify-content-end" id="navigation">
                        <ul class="navbar-nav ml-auto">
                            <li class="nav-item">
                                <a class="nav-link" href="#pablo">
                                    <span class="no-icon" onclick="logOut()">Log out</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
            <!-- End Navbar -->
            <div class="content">
                <div id="app" class="container-fluid">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card strpied-tabled-with-hover">
                                <div class="card-header ">
                                    <h4 class="card-title" onclick="demoforum()">討論區</h4>
                                    <p class="card-category">修改內容</p>
                                </div>
                                <div class="card-body table-full-width table-responsive">
                                    <table class="table table-hover table-striped" id="datatable">
                                        <thead>
                                            <form name='form' action='#' method='post' class="formtxt">
                                                <p class="midcenter"><label style="margin-right: 2px;"></label>
                                                    <input type="text" list="browsers" name="myBrowser" id="memberedit"
                                                        class="inputname"></p>
                                                <datalist id="browsers">
                                                </datalist>
                                                <!-- <p id="membertxt" class="marginleft">登入系統人:<br /><input type="text" id="memberedit"
                                                        placeholder="管理員mb_ID目前設定為12"></p> -->
                                                <br />
                                                <p class="marginleft">標題:<br /><input type="text" id="titleedit"></p>
                                                <br />
                                                <p class="marginleft">
                                                    文章類型 :
                                                    <select id="forumType">
                                                        <option value="1">公告</option>
                                                        <option value="2">訊息</option>
                                                    </select>
                                                </p><br />

                                                <p class="marginleft">內容:
                                                    <textarea name="contenttxt" id="contenttxt" rows="10"
                                                        cols="80"></textarea></p>

                                                <script>
                                                    CKEDITOR.replace('contenttxt', { width: 700, });
                                                    const intxt = CKEDITOR.instances.contenttxt.getData();
                                                </script>
                                                <p class="marginleft"><input type='button' value='送出'
                                                        onclick="sendData()"></p>
                                            </form><br /><br />

                                            <input type="text" class="search_txt marginleft" placeholder="以發文者ID搜尋"
                                                id="srchPoster_ID">
                                            <button onclick="`${getDataKey()}`"><i class="fas fa-search"></i></button>

                                            <tr>
                                                <th>文章ID</th>
                                                <th>發文者姓名</th>
                                                <th>發文者ID</th>
                                                <th>文章類型</th>
                                                <th>文章所屬部門</th>
                                                <th>文章標題</th>
                                                <th>文章內容</th>
                                                <th>文章日期</th>
                                                <!-- <th>文章圖片</th> -->
                                                <!-- <th>文章按讚數</th> -->
                                                <th>回覆訊息</th>
                                                <th>修改</th>
                                                <th>刪除</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tr_forum">
                                            <!-- <tr>
                                                <td>1</td>
                                                <td>Dakota Rice</td>
                                                <td>$36,738</td>
                                                <td>Niger</td>
                                                <td>Oud-Turnhout</td>
                                            </tr> -->

                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="card card-plain table-plain-bg">
                                <div class="card-header ">

                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="footer">
                <div class="container-fluid">
                    <nav>
                        <p class="copyright text-center">
                            © Gladxy Co.有限公司
                        </p>
                    </nav>
                </div>
            </footer>
        </div>
    </div>

    //===========dialog get message=====
    <div class="modal fade bd-example-modal-xl" id="editMessage" tabindex="-1" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <table class="table table-hover table-striped" id="datatable">
                    <thead>
                        <tr>
                            <th>發文者姓名</th>
                            <th>訊息ID</th>
                            <th>訊息內容</th>
                            <th>訊息日期</th>
                            <th>刪除</th>
                        </tr>
                    </thead>
                    <tbody id="tr_Mes">
                        <!-- <tr>
                            <td>charry</td>
                            <td>14</td>
                            <td>content</td>
                            <td>datetime</td>
                            <td><button onclick="MesDelete()">刪除<i class="fas fa-trash-alt"></i></button></td>
                        </tr> -->

                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="../assets/js/core/jquery.3.2.1.min.js" type="text/javascript"></script>
    <script src="../assets/js/core/popper.min.js" type="text/javascript"></script>
    <script src="../assets/js/core/bootstrap.min.js" type="text/javascript"></script>
    <!--  Plugin for Switches, full documentation here: http://www.jque.re/plugins/version3/bootstrap.switch/ -->
    <script src="../assets/js/plugins/bootstrap-switch.js"></script>
    <!--  Google Maps Plugin    -->
    <!-- <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=YOUR_KEY_HERE"></script> -->
    <!--  Chartist Plugin  -->
    <script src="../assets/js/plugins/chartist.min.js"></script>
    <!--  Notifications Plugin    -->
    <script src="../assets/js/plugins/bootstrap-notify.js"></script>
    <!-- Control Center for Light Bootstrap Dashboard: scripts for the example pages etc -->
    <script src="../assets/js/light-bootstrap-dashboard.js?v=2.0.0 " type="text/javascript"></script>
    <!-- Light Bootstrap Dashboard DEMO methods, don't include it in your project! -->
    <script src="../assets/js/demo.js"></script>

    <script>
        const request = new XMLHttpRequest();
        jQuery.support.cors = true;

        let cURL = 'https://1fuen12iii.azurewebsites.net';

        const content_tpl = tpl => {
            return `
        <tr>
            <td>${tpl.fID}</td>
            <td id="fName${tpl.fID}">${tpl.fName}</td>
            <td id="fPoNameID${tpl.fID}">${tpl.fPoNameID}</td>
            <td id="fType${tpl.fID}">${tpl.fType}</td>
            <td id="fDept${tpl.fID}">${tpl.fDept}</td>
            <td contentEditable="true" id="fTitle${tpl.fID}" >${tpl.fTitle}</td>
            <td contentEditable="true" id="fContent${tpl.fID}">${tpl.fContent}</td>
            <td contentEditable="true" id="fdate${tpl.fID}">${tpl.fdate}</td>
            <td><button onclick="getMes(${tpl.fID})" type="button" class="btn btn-primary" data-toggle="modal"
                data-target=".bd-example-modal-xl">訊息</button></td>  
            <td><button  class="btn btn-primary" onclick="putEditData(${tpl.fID})">修改<i class="fas fa-edit"></i></button></td>                  
            <td><button class="btn btn-danger" onclick="getData_delete(${tpl.fID})">刪除<i class="fas fa-trash-alt"></i></button></td>
        
         </tr>
        `

        }

        const mes_tpl = Mtpl => {
            return `
        <tr>
            <td>${Mtpl.fMName}</td>
            <td>${Mtpl.fMID}</td>
            <td>${Mtpl.fMContent}</td>
            <td>${Mtpl.fMesTime}</td>
            <td><button onclick="DeleteMes(${Mtpl.fMID},${Mtpl.fContent})">刪除<i class="fas fa-trash-alt"></i></button></td>
        </tr>
        `
        }



        const sendHttpRequest = (method, url, data) => {  //fetch的上半部整理成function
            return fetch(url, {
                method: method,
                body: JSON.stringify(data),
                headers: data ? { 'Content-Type': 'application/json', } : {
                    Authorization:
                        'Bearer ' + localStorage.getItem("token")
                } //{}裡面可放物件//三元表達式
            })  //get data  
                .then(response => {
                    if (response.status >= 400) {       //參考xml httprequest對於錯誤的處理方法
                        //!response.ok
                        return response.json().then(errResData => {
                            const error = new Error('Something went wrong!');
                            error.data = errResData;   //找出錯誤的資料為何
                            throw error;
                        });
                    }
                    return response.json();
                })
        }

        //=====get message=====
        const getMes = (articleID) => {
            let UrlGetID = cURL + `/api/MessageAPI/${articleID}`
            sendHttpRequest('get', UrlGetID)
                .then(responseData => {

                    responseData.ftable.forEach(i => {
                        //console.log(i.message.fmessage);

                        let arr = i.message.fmessage;
                        //console.log(arr);

                        let strMes = '';
                        arr.map(m => {
                            count = m.count;
                            strMes += mes_tpl(m);
                        })
                        $('#tr_Mes').html(strMes);
                    })
                }).catch(err => {
                    console.log(err, err.data);
                });
        }

        //======delete message======
        const DeleteMes = (MesID, forumID) => {
            var check = confirm("確定要刪除這則訊息嗎?");
            if (!check) {
                return
            };
            let UrlGetID = cURL + `/api/MessageAPI/${MesID}`
            sendHttpRequest('delete', UrlGetID)
                .then(responseData => {
                    //confirm("刪除成功");
                    getMes(forumID);
                }).catch(err => {
                    console.log(err, err.data);
                });
            //request.onload = getMes(forumID);
        }


        //======get article=====
        const getData = () => {
            sendHttpRequest('get', cURL + '/api/forumback')
                .then(responseData => {
                    let str = '';
                    responseData.ftable.forEach(i => {
                        count = i.count;
                        str += content_tpl(i);
                    })
                    $('#tr_forum').html(str);
                })
        };
        request.onload = getData();

        //=======get search======
        const getDataKey = () => {
            if (srchPoster_ID.value == 0) {
                getData();
                return
            }
            else {

                const url = cURL + `/forumback/?srchPoster_ID=${srchPoster_ID.value}`
                sendHttpRequest('get', url)
                    .then(responseData => {
                        let str = '';
                        responseData.ftable.forEach(i => {
                            count = i.count;
                            str += content_tpl(i);
                        })
                        $('#tr_forum').html(str);
                        // request.onload = getData();

                    })
            }

        };
        const putEditData = (id) => {
            // currentPost.iID
            const type = document.querySelector(`#fType${id}`).innerText
            const title = document.querySelector(`#fTitle${id}`).innerText
            const content = document.querySelector(`#fContent${id}`).innerText;
            const date = document.querySelector(`#fdate${id}`).innerText;

            let UrlPutID = cURL + `/api/forumback/?putID=${id}`
            sendHttpRequest('Put', UrlPutID, {
                "title": title,
                "content": content,
            }).then(responseData => {
                console.log(responseData);
                request.onload = getData();
            }).catch(err => {
                console.log(err, err.data);
            });

        };

        const getData_delete = (id) => {
            var check = confirm("確定要刪除嗎?");
            if (!check) {
                return
            };
            let UrlPutID = cURL + `/api/forumback/?id=${id}`
            sendHttpRequest('Delete', UrlPutID
            ).then(responseData => {
                console.log(responseData);
                //console.log(typeof responseData);
                console.log(id);
                //console.log(message.fmessage);
                request.onload = getData();
            }).catch(err => {
                console.log(err, err.data);
            });

        };

        const idArr = []
        const nameArr = []

        $.ajax({
            url: cURL + "/api/memberback",
            type: "GET", headers: { Authorization: 'Bearer ' + localStorage.getItem("Packagetoken") },
            success: function (response) {
                response.ftable.forEach((v, i) => {
                    idArr[i] = v.id
                    nameArr[i] = v.name
                });

            }
        });


        console.log(idArr)

        const sendData = () => {
            if (!document.getElementById("titleedit").value) {
                alert('請填入標題!');
            }
            else if (!CKEDITOR.instances.contenttxt.getData()) {
                alert('請填入內容!');
            }
            else {
                sendHttpRequest('post', cURL + '/api/forumback', {
                    "type": document.getElementById('forumType').value,
                    "id": idArr[nameArr.indexOf(document.getElementById("memberedit").value)],
                    "title": document.getElementById("titleedit").value,
                    "content": CKEDITOR.instances.contenttxt.getData(),
                    //"member": document.getElementById("memberedit").value,
                }).then(responseData => {
                    document.getElementById("titleedit").value = "";
                    CKEDITOR.instances.contenttxt.setData('');
                    //再次從server取資料
                    request.onload = getData();
                }).catch(err => {
                    console.log(err, err.data);
                });
            }
        };
        function logOut() {
            location.href = "login.html"
            localStorage.removeItem("token");
        }


        let availableTags;
        const string1 = [];
        let selectTags;
        const string2 = [];

        $.ajax({
            url: cURL + "/api/memberback",
            type: "GET", headers: { Authorization: 'Bearer ' + localStorage.getItem("token") },
            success: function (response) {


                response.ftable.forEach((v, i) => {
                    string1[i] = v.id
                    string2[i] = v.name
                });
                selectTags = string2.splice(",");

                selectTags.forEach(element => {//console.log(element);
                    document.getElementById('browsers').innerHTML += `<option value="${element}">${element}</option>`
                });
            }
        });

        function logOut() {
            localStorage.removeItem("token");
            location.href = "login.html"
        }

        function demoforum() {
            document.getElementById("titleedit").value = "調薪20％羨煞旁人?";
            CKEDITOR.instances.contenttxt.setData('自2021年1月1日起，我們將對由台積電公司直接聘僱之台灣正職且有參與員工分紅的同仁進行薪酬結構的調整，將部分變動薪酬轉換為固定薪酬，來提昇人才留任與招募上的競爭力。');
        }

    </script>


</body>

</html>